<!DOCTYPE html>
<html class='w-full' lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Selector</title>
    <script src="https://unpkg.com/htmx.org@1.8.4"></script>
    <link rel="stylesheet" href="/style.css">
    <script>
        languages = ["english", "spanish", "mandarin", "japanese", "russian", "hindi", "arabic", "portuguese"]
        // append options to default select

        options = languages.map(lang => `<option value='${lang}'>${lang}</option>`)


        // create default table if none exists
        if(localStorage.getItem('table') === null || localStorage.getItem('table') === '') {
          localStorage.setItem('table', JSON.stringify([
            ['english', 'spanish'],
            ['', ''],
          ]));
        }

        // build table html from local storage
        html = '';
        JSON.parse(localStorage.getItem('table')).forEach((row, i) => {
          // First row is only selects (languages)
          if (i == 0) {
            html += "<div class='flex flex-row languages row w-full'>";
            row.forEach((language, j) => {
              html += `<select name="language" class="w-64 language p-2 defaultSelect" onchange="translateColumn(this)">`;
              html += `<option value="${language}">${language}</option>`;
              html += '</select>';
            });
            html += '</div>';
          }
          else{
            html += "<div class='flex flex-row phrases row w-full'>";
            // All other rows are 1 input and n divs (phrases)
            row.forEach((cell, j) => {
              // first cell is input
              if (j == 0) {
                html += '<input type="text" name="text" class="w-64 p-2 phrase" onchange="gtranslate(this)">';
              }
              else{
                // all other cells are divs (phrases)
                html += '<div class="inline-block w-64 border-1 border-[#767676] border-solid p-2 translatedPhrase"></div>';
              }
            });
          }
        html += '</div>';
        });

        window.onload = function() {
          // render table, append to table div
          document.querySelector('.table').insertAdjacentHTML('beforeend', html);
        };

        function add_col() {
          let localStorageVal = []
          table = JSON.parse(localStorage.getItem('table'))
          let numColumns = document.querySelectorAll('.language').length;
          if (numColumns === languages.length){
            alert('Max languages reached')
            return;
          }

          const rows = document.querySelectorAll('.row');
          // iterate through all rows, translate the first cell if it has text
          // first row is selects (languages), other rows are 1 input and n divs (phrases)
          // if 
          for (let i = 0; i < rows.length; i++) {
            if (i === 0) {
              rows[i].insertAdjacentHTML('beforeend', `
                <select onchange='translateColumn(this)' name='language' class='w-64 language p-2'>
                  ${options.map((opt, index) => 
                    `<option value='${languages[index]}' ${index === numColumns ? 'selected' : ''}>${languages[index]}</option>`
                  ).join('')}
                </select>
              `);
              //localStorageVal.push(languages[numColumns]);
              table = JSON.parse(localStorage.getItem('table'))
              table[i].push(val)
              localStorage.setItem('table', JSON.stringify(table));
            } else {
              // create a div and update it with the translation later
              rows[i].insertAdjacentHTML('beforeend', `<div class='w-64 border p-2 inline-block translatedPhrase'></div>`);
              // if input is empty, don't translate
              if (rows[i].querySelector('input').value === '') {
                localStorageVal.push('');
                localStorage.setItem('table', JSON.stringify(table));
                continue;
              }
              fetch('http://localhost:3000/translate', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  phrase: rows[i].querySelector('input').value,
                  target_language: languages[numColumns]
                })
              })
              .then(response => response.json())
              .then(data => {
                // update the div with the translation
                rows[i].lastElementChild.textContent = data.translated_text;
                // this is async and may not be updated by the time the table is written to local storage
                localStorageVal.push(data.translated_text);
              })
              .catch(error => {
                rows[i].lastElementChild.textContent = 'Translation failed';
                console.error('Translation error:', error);
              });
            }
          }
          /*
          The issue is 
          */
          table = JSON.parse(localStorage.getItem('table'))
          table.forEach((row, i) => {
            row.push(localStorageVal[i]);
          })
          localStorage.setItem('table', JSON.stringify(table));
        }

        function add_row() {
          // add <div>1<input>#cols<div></div></div>
          
          let html = `
          <div class='phrases flex flex-row row w-full'>
            <input onchange='gtranslate(this)' type='text' name='text' class='w-64 p-2 phrases'></input>
          `
          document.querySelectorAll('.language').forEach((lang, i) => {
            if (i > 0) {
              html += `
              <div class='inline-block w-64 border-1 border-[#767676] border-solid p-2 translatedPhrase'></div>
              `
            }
          });
          html += `</div>`
          document.querySelector('.table').insertAdjacentHTML('beforeend', html);
        }

        function gtranslate(input) {
          /* 
          textInput onChange, iterate through the cells of the row / over the columns. translate first cell (text input) with the column language (select values)
          */

          // if text input is empty, don't translate
          if (input.value === '') return;

          // get all but first column
          const languageSelects = [...document.querySelectorAll('.language')].slice(1);
          const translationDivs = input.parentElement.querySelectorAll('.translatedPhrase');
          
          // iterate over all columns of the text input row
          languageSelects.forEach((langSelect, i) => {
              fetch('http://localhost:3000/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                phrase: input.value,
                target_language: langSelect.value
              })
              })
              .then(response => response.json())
              .then(data => {
                translationDivs[i].textContent = data.translated_text;
              })
              .catch(error => {
                translationDivs[i].textContent = 'Translation failed';
                console.error('Translation error:', error);
                });
          });
        }

        function translateColumn(select) {
          /* 
          When language selector changes:
          1. Get column index
          2. Get all phrase rows and filter out empty ones
          3. For each row with text, translate and update the corresponding column
          */
          // 1. Get column index
          const columnIndex = [...select.parentElement.children].indexOf(select);
          
          // 2. Get all phrase rows and filter out empty ones
          [...document.querySelectorAll('.phrases.row')]
            .filter(row => row.querySelector('input').value)
            .forEach(row => {
              // 3. Translate and update the corresponding column
              fetch('http://localhost:3000/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  phrase: row.querySelector('input').value,
                  target_language: select.value
                })
              })
              .then(response => response.json())
              .then(data => {
                row.children[columnIndex].textContent = data.translated_text;
              })
              .catch(error => {
                row.children[columnIndex].textContent = 'Translation failed';
                console.error('Translation error:', error);
              });
            });
        }
    </script>
  </head>
  <body class='w-full'>
    <h1>Polyglot</h1>

    <!-- buttons -->
    <div class="pb-2">
    <button onclick="add_col()">
      Add Language (column)
    </button>
    <button onclick="add_row()">
      Add Phrase (row)
    </button>
    </div>
    <!-- table-->
    <div class='overflow-x-auto w-full whitespace-nowrap table'>
    </div>
  </body>
</html>
